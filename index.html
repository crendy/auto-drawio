<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>auto-drawio - AIæµç¨‹å›¾ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* å·¦ä¾§ AI å¯¹è¯åŒº */
        .chat-panel {
            width: 400px;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            background: #fff;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-header h2 {
            font-size: 18px;
            color: #212529;
        }

        /* æç¤ºæ¨ªå¹… */
        .tip-banner {
            padding: 6px 12px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 16px;
            font-size: 13px;
            color: #856404;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tip-banner-icon {
            font-size: 14px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 16px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-user {
            text-align: right;
        }

        .message-ai {
            text-align: left;
        }

        .message-content {
            display: inline-block;
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 8px;
            word-wrap: break-word;
        }

        .message-user .message-content {
            background: #007bff;
            color: white;
        }

        .message-ai .message-content {
            background: white;
            color: #212529;
            border: 1px solid #dee2e6;
        }

        .stream-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-top: 8px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            user-select: text;
            cursor: text;
        }

        .stream-status {
            color: #007bff;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .stream-status.completed {
            color: #28a745;
        }

        .stream-status.error {
            color: #dc3545;
        }

        .chat-input-area {
            padding: 20px;
            background: #fff;
            border-top: 1px solid #dee2e6;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
        }

        .chat-input:focus {
            border-color: #007bff;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-primary:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .action-buttons {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        /* å³ä¾§ Draw.io ç¼–è¾‘åŒº */
        .editor-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
        }

        .editor-header {
            padding: 16px 20px;
            background: #fff;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .editor-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .editor-header-center {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .editor-header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .editor-actions {
            display: flex;
            gap: 8px;
        }

        .editor-header h2 {
            font-size: 18px;
            color: #212529;
        }

        .editor-container {
            flex: 1;
            position: relative;
        }

        .editor-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
        }

        .empty-state svg {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-ready {
            background: #d4edda;
            color: #155724;
        }

        .status-loading {
            background: #fff3cd;
            color: #856404;
        }

        /* è®¾ç½®æŒ‰é’® */
        .settings-btn {
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .settings-btn:hover {
            background: #5a6268;
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 15px;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            color: #212529;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #6c757d;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 28px;
        }

        .close-btn:hover {
            color: #000;
        }

        /* é…ç½®åˆ—è¡¨ */
        .config-list {
            margin-bottom: 20px;
        }

        .config-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .config-name {
            font-weight: bold;
            font-size: 16px;
            color: #212529;
        }

        .config-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .config-details {
            font-size: 13px;
            color: #495057;
        }

        .config-details div {
            margin: 5px 0;
            word-break: break-all;
        }

        .config-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }

        .config-enabled {
            background: #d4edda;
            color: #155724;
        }

        .config-disabled {
            background: #f8d7da;
            color: #721c24;
        }

        /* è¡¨å• */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #212529;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #007bff;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-add {
            background: #28a745;
            color: white;
            margin-bottom: 20px;
        }

        .btn-add:hover {
            background: #218838;
        }

        /* æ ¼å¼é€‰æ‹©æ¨¡æ€æ¡† */
        .format-selector {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            min-width: 300px;
        }

        .format-selector.active {
            display: block;
        }

        .format-selector h4 {
            margin: 0 0 16px 0;
            font-size: 18px;
            color: #212529;
        }

        .format-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 16px;
        }

        .format-option {
            padding: 12px 16px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .format-option:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }

        .format-option input[type="radio"] {
            cursor: pointer;
        }

        .format-option label {
            cursor: pointer;
            flex: 1;
            margin: 0;
        }

        .format-description {
            font-size: 12px;
            color: #6c757d;
            display: block;
            margin-top: 4px;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.3);
        }

        .modal-overlay.active {
            display: block;
        }

        /* å¿«æ·æé—®æŒ‰é’® */
        .quick-questions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .quick-question-btn {
            padding: 8px 14px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 16px;
            font-size: 13px;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            flex: 1;
            min-width: 0;
        }

        .quick-question-btn:hover {
            background: #e9ecef;
            border-color: #007bff;
            color: #007bff;
        }

        .quick-question-btn:active {
            transform: scale(0.98);
        }

        /* æ¨¡æ¿é€‰æ‹©åŒºåŸŸ */
        .template-area {
            margin-bottom: 12px;
        }

        .template-label {
            font-size: 13px;
            color: #495057;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .template-toggle-btn {
            margin-left: auto;
            padding: 4px 10px;
            background: transparent;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            color: #495057;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-toggle-btn:hover {
            background: #f8f9fa;
            border-color: #1e40af;
            color: #1e40af;
        }

        .template-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .template-list.expanded {
            max-height: 800px;
        }

        .template-card {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: #ffffff;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-card:hover {
            border-color: #1e40af;
            box-shadow: 0 2px 8px rgba(30, 64, 175, 0.1);
        }

        .template-card.active {
            border-color: #1e40af;
            background: #f0f9ff;
            box-shadow: 0 2px 12px rgba(30, 64, 175, 0.15);
        }

        .template-preview {
            flex-shrink: 0;
            width: 120px;
            height: 90px;
            border-radius: 6px;
            overflow: hidden;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .template-preview img,
        .template-preview svg {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .template-content {
            flex: 1;
            min-width: 0;
        }

        .template-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .template-icon {
            font-size: 18px;
        }

        .template-name {
            font-size: 14px;
            font-weight: 600;
            color: #212529;
        }

        .template-description {
            font-size: 12px;
            color: #6c757d;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .template-tags {
            display: flex;
            gap: 6px;
            margin-top: 6px;
            flex-wrap: wrap;
        }

        .template-tag {
            padding: 2px 8px;
            background: #e9ecef;
            border-radius: 12px;
            font-size: 11px;
            color: #495057;
        }

        .template-card.active .template-tag {
            background: #bae6fd;
            color: #0c4a6e;
        }

        .template-clear-btn {
            margin-left: auto;
            padding: 4px 10px;
            background: transparent;
            border: none;
            color: #6c757d;
            font-size: 12px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .template-clear-btn:hover {
            color: #dc3545;
        }

        /* æ¨¡æ¿é¡µé¢æ¨¡æ€çª—å£ */
        .template-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            animation: fadeIn 0.3s;
        }

        .template-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .template-modal-content {
            background: #ffffff;
            width: 90%;
            max-width: 1200px;
            height: 85vh;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .template-modal-header {
            padding: 24px 32px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .template-modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #212529;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .template-modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            color: #6c757d;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .template-modal-close:hover {
            background: #e9ecef;
            color: #212529;
        }

        .template-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
        }

        .template-card-large {
            background: #ffffff;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
        }

        .template-card-large:hover {
            border-color: #1e40af;
            box-shadow: 0 4px 16px rgba(30, 64, 175, 0.15);
            transform: translateY(-4px);
        }

        .template-card-large.active {
            border-color: #1e40af;
            background: #f0f9ff;
            box-shadow: 0 4px 20px rgba(30, 64, 175, 0.2);
        }

        .template-card-large.active::before {
            content: 'âœ“';
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            background: #1e40af;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            z-index: 1;
        }

        .template-card-large {
            position: relative;
        }

        .template-preview-large {
            width: 100%;
            height: 200px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .template-preview-large svg {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 20px;
        }

        .template-card-large-content {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .template-card-large-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .template-icon-large {
            font-size: 28px;
        }

        .template-name-large {
            font-size: 18px;
            font-weight: 600;
            color: #212529;
        }

        .template-description-large {
            font-size: 14px;
            color: #6c757d;
            line-height: 1.6;
            margin-bottom: 16px;
            flex: 1;
        }

        .template-tags-large {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .template-tag-large {
            padding: 4px 12px;
            background: #e9ecef;
            border-radius: 16px;
            font-size: 12px;
            color: #495057;
        }

        .template-card-large.active .template-tag-large {
            background: #bae6fd;
            color: #0c4a6e;
        }

        .template-modal-footer {
            padding: 20px 32px;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .template-selected-info {
            font-size: 14px;
            color: #6c757d;
        }

        .template-selected-info strong {
            color: #1e40af;
            font-weight: 600;
        }

        .template-modal-actions {
            display: flex;
            gap: 12px;
        }

        .btn-template-cancel {
            padding: 10px 24px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-template-cancel:hover {
            background: #e9ecef;
        }

        .btn-template-apply {
            padding: 10px 32px;
            background: #1e40af;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-template-apply:hover {
            background: #1e3a8a;
        }

        .btn-template-apply:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }

        /* æ¨¡æ¿è¯¦æƒ…é¡µæ ·å¼ */
        .template-detail-page {
            display: none;
        }

        .template-detail-page.show {
            display: flex;
        }

        .btn-back {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 16px;
        }

        .btn-back:hover {
            background: #f8f9fa;
            border-color: #1e40af;
            color: #1e40af;
        }

        .template-detail-body {
            padding: 0;
        }

        .template-detail-container {
            height: 100%;
            overflow-y: auto;
        }

        .template-detail-section {
            padding: 32px;
            border-bottom: 1px solid #dee2e6;
        }

        .template-detail-section:last-child {
            border-bottom: none;
        }

        .template-detail-section-title {
            font-size: 18px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .template-detail-section-content {
            font-size: 14px;
            line-height: 1.8;
            color: #495057;
        }

        .template-detail-tags {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .template-detail-tag {
            padding: 6px 16px;
            background: #e9ecef;
            border-radius: 20px;
            font-size: 13px;
            color: #495057;
        }

        .template-detail-preview {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .template-detail-preview img,
        .template-detail-preview svg {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .template-prompt-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: #212529;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .template-example-images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .template-example-item {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s;
        }

        .template-example-item:hover {
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }

        .template-example-title {
            font-size: 14px;
            font-weight: 500;
            color: #212529;
            margin-bottom: 12px;
        }

        .template-example-img {
            width: 100%;
            height: auto;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .template-detail-actions {
            display: flex;
            gap: 12px;
            width: 100%;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§ AI å¯¹è¯åŒº -->
        <div class="chat-panel">
            <div class="chat-header">
                <h2>auto-drawio</h2>
                <button class="btn btn-secondary btn-small" onclick="openTemplateModal()" style="margin-left: auto;">
                    ğŸ¨ æ¨¡æ¿
                </button>
                <button class="btn btn-secondary btn-small" onclick="newConversation()">
                    æ–°å»ºä¼šè¯
                </button>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message message-ai">
                    <div class="message-content">
                        ä½ å¥½ï¼æˆ‘æ˜¯ auto-drawioã€‚<br>
                        <span style="color: #856404;">â³ ç¼–è¾‘å™¨æ­£åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨å€™...</span><br><br>
                        åˆå§‹åŒ–å®Œæˆåï¼Œä½ å¯ä»¥æè¿°æƒ³è¦ç”Ÿæˆçš„æµç¨‹å›¾ï¼Œä¾‹å¦‚ï¼š<br>
                        â€¢ "ç”Ÿæˆä¸€ä¸ªç”¨æˆ·ç™»å½•æµç¨‹å›¾"<br>
                        â€¢ "åˆ›å»ºè®¢å•å¤„ç†æµç¨‹"<br>
                        â€¢ "è®¾è®¡æ”¯ä»˜ç³»ç»Ÿæ¶æ„å›¾"
                    </div>
                </div>
            </div>

            <div class="chat-input-area">
                <!-- å¿«æ·æé—®æŒ‰é’® -->
                <div class="quick-questions">
                    <button class="quick-question-btn" onclick="quickQuestion('ç”Ÿæˆä¸€ä¸ªç”¨æˆ·ç™»å½•æµç¨‹å›¾')" disabled>
                        ç”¨æˆ·ç™»å½•æµç¨‹
                    </button>
                    <button class="quick-question-btn" onclick="quickQuestion('åˆ›å»ºä¸€ä¸ªç”µå•†è®¢å•å¤„ç†æµç¨‹')" disabled>
                        è®¢å•å¤„ç†æµç¨‹
                    </button>
                    <button class="quick-question-btn" onclick="quickQuestion('è®¾è®¡ä¸€ä¸ªæ”¯ä»˜ç³»ç»Ÿæ¶æ„å›¾')" disabled>
                        æ”¯ä»˜ç³»ç»Ÿæ¶æ„
                    </button>
                </div>

                <div class="input-group">
                    <input
                        type="text"
                        class="chat-input"
                        id="userInput"
                        placeholder="ç­‰å¾…ç¼–è¾‘å™¨åˆå§‹åŒ–..."
                        onkeypress="handleKeyPress(event)"
                        disabled
                    />
                    <button class="btn btn-primary" id="generateBtn" onclick="generateDiagram()" disabled>
                        ç”Ÿæˆ
                    </button>
                </div>
                <!-- éšè—çš„æ–‡ä»¶é€‰æ‹©å™¨ -->
                <input type="file" id="fileInput" accept=".xml,.drawio" style="display: none;" onchange="handleFileSelect(event)" />
            </div>
        </div>

        <!-- å³ä¾§ Draw.io ç¼–è¾‘åŒº -->
        <div class="editor-panel">
            <div class="editor-header">
                <div class="editor-header-left">
                    <span class="status-badge status-loading" id="statusBadge">åˆå§‹åŒ–ä¸­...</span>
                </div>
                <div class="editor-header-center">
                    <!-- æç¤ºæ¨ªå¹… -->
                    <div class="tip-banner">
                        <span class="tip-banner-icon">ğŸ’¡</span>
                        <span>å¦‚æœç”Ÿæˆæ•ˆæœä¸ä½³ï¼Œå»ºè®®ç‚¹å‡»"æ–°å»ºä¼šè¯"é‡æ–°å¼€å§‹</span>
                    </div>
                </div>
                <div class="editor-header-right">
                    <div class="editor-actions">
                        <button class="btn btn-secondary btn-small" onclick="openSettings()">
                            æ¨¡å‹é…ç½®
                        </button>
                        <button class="btn btn-success btn-small" id="exportImageBtn" onclick="exportAsImage()" disabled>
                            å¯¼å‡ºå›¾ç‰‡
                        </button>
                        <!-- æš‚æ—¶éšè—çš„æŒ‰é’® -->
                        <button class="btn btn-success btn-small" onclick="importDiagram()" style="display: none;">
                            å¯¼å…¥ XML
                        </button>
                        <button class="btn btn-success btn-small" onclick="saveDiagram()" style="display: none;">
                            ä¿å­˜å›¾è¡¨
                        </button>
                        <button class="btn btn-success btn-small" onclick="exportDiagram()" style="display: none;">
                            å¯¼å‡ºå›¾è¡¨
                        </button>
                    </div>
                </div>
            </div>

            <div class="editor-container">
                <!-- ç©ºçŠ¶æ€æç¤º -->
                <div class="empty-state" id="emptyState">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p>è¿˜æ²¡æœ‰æµç¨‹å›¾</p>
                    <p style="font-size: 14px; margin-top: 8px;">åœ¨å·¦ä¾§è¾“å…¥æè¿°ï¼Œè®© AI ä¸ºä½ ç”Ÿæˆ</p>
                </div>

                <!-- åŠ è½½ä¸­ -->
                <div class="loading" id="loadingState">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨ç”Ÿæˆæµç¨‹å›¾...</p>
                </div>

                <!-- Draw.io ç¼–è¾‘å™¨ iframe -->
                <iframe
                    id="drawioEditor"
                    class="editor-iframe"
                    style="display: none;"
                    src="https://embed.diagrams.net/?embed=1&proto=json&spin=1&saveAndExit=0&noSaveBtn=1&noExitBtn=1&libraries=1&ui=kennedy"
                ></iframe>
            </div>
        </div>
    </div>

    <!-- AI é…ç½®ç®¡ç†æ¨¡æ€æ¡† -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>AI æ¨¡å‹é…ç½®</h3>
                <button class="close-btn" onclick="closeSettings()">&times;</button>
            </div>

            <button class="btn btn-add" onclick="showAddConfigForm()">+ æ·»åŠ æ–°é…ç½®</button>

            <!-- é…ç½®åˆ—è¡¨ -->
            <div class="config-list" id="configList">
                <p style="text-align: center; color: #6c757d;">åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- æ ¼å¼é€‰æ‹©é®ç½©å±‚ -->
    <div class="modal-overlay" id="formatOverlay" onclick="closeFormatSelector()"></div>

    <!-- æ ¼å¼é€‰æ‹©å™¨ -->
    <div class="format-selector" id="formatSelector">
        <h4>é€‰æ‹©å¯¼å‡ºæ ¼å¼</h4>
        <div class="format-options">
            <div class="format-option" onclick="selectFormat('png')">
                <input type="radio" name="format" id="formatPNG" value="png" checked>
                <label for="formatPNG">
                    <strong>PNG æ ¼å¼</strong>
                    <span class="format-description">é€‚åˆç½‘é¡µä½¿ç”¨ï¼Œæ”¯æŒé€æ˜èƒŒæ™¯ï¼Œæ–‡ä»¶è¾ƒå¤§</span>
                </label>
            </div>
            <div class="format-option" onclick="selectFormat('jpg')">
                <input type="radio" name="format" id="formatJPG" value="jpg">
                <label for="formatJPG">
                    <strong>JPG æ ¼å¼</strong>
                    <span class="format-description">æ–‡ä»¶è¾ƒå°ï¼Œé€‚åˆæ‰“å°å’Œåˆ†äº«ï¼Œä¸æ”¯æŒé€æ˜</span>
                </label>
            </div>
            <div class="format-option" onclick="selectFormat('svg')">
                <input type="radio" name="format" id="formatSVG" value="svg">
                <label for="formatSVG">
                    <strong>SVG æ ¼å¼</strong>
                    <span class="format-description">çŸ¢é‡å›¾ï¼Œå¯æ— é™ç¼©æ”¾ä¸å¤±çœŸï¼Œé€‚åˆç¼–è¾‘</span>
                </label>
            </div>
        </div>
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeFormatSelector()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" onclick="confirmExport()">ç¡®å®šå¯¼å‡º</button>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘é…ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="configFormModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="formTitle">æ·»åŠ æ–°é…ç½®</h3>
                <button class="close-btn" onclick="closeConfigForm()">&times;</button>
            </div>

            <form id="configForm" onsubmit="saveConfig(event)">
                <input type="hidden" id="configId" value="">

                <div class="form-group">
                    <label>é…ç½®åç§° *</label>
                    <input type="text" id="configName" required placeholder="ä¾‹å¦‚: OpenAI GPT-4">
                </div>

                <div class="form-group">
                    <label>API åŸºç¡€ URL *</label>
                    <input type="url" id="configBaseUrl" required placeholder="ä¾‹å¦‚: https://api.openai.com/v1">
                </div>

                <div class="form-group">
                    <label>API å¯†é’¥ *</label>
                    <input type="text" id="configApiKey" required placeholder="sk-...">
                </div>

                <div class="form-group">
                    <label>æ¨¡å‹åç§° *</label>
                    <input type="text" id="configModel" required placeholder="ä¾‹å¦‚: gpt-4">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeConfigForm()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let editorFrame = null;
        let currentXML = null;
        let isEditorReady = false;
        let conversationHistory = [];  // å¯¹è¯å†å²
        let lastFailedXML = null;      // æœ€åä¸€æ¬¡å¤±è´¥çš„ XML
        let lastValidationError = null; // æœ€åä¸€æ¬¡éªŒè¯é”™è¯¯
        let lastPrompt = null;          // æœ€åä¸€æ¬¡çš„æç¤ºè¯ï¼ˆç”¨äºæ‰‹åŠ¨é‡è¯•ï¼‰
        let failedAPIs = [];            // æœ¬æ¬¡ç”Ÿæˆä¸­å¤±è´¥çš„ API åˆ—è¡¨
        let lastUsedAPI = null;         // æœ€åä½¿ç”¨çš„ API åç§°
        let lastFailedMessageDiv = null; // æœ€åå¤±è´¥çš„æ¶ˆæ¯æ¡†
        let exportingImage = false;     // æ ‡è®°æ˜¯å¦æ­£åœ¨å¯¼å‡ºå›¾ç‰‡
        let currentTemplate = null;     // å½“å‰é€‰ä¸­çš„æ¨¡æ¿

        // æ¨¡æ¿å®šä¹‰
        const templates = [
            {
                id: "academic-style",
                name: "ç§‘ç ”ç»˜å›¾é£æ ¼",
                description: "é€‚ç”¨äºå­¦æœ¯è®ºæ–‡ã€é¡¶ä¼šè®ºæ–‡çš„ä¸“ä¸šç»˜å›¾ï¼Œéµå¾ªå­¦æœ¯è§„èŒƒï¼Œç°åº¦é…è‰²ï¼Œç¡®ä¿é»‘ç™½æ‰“å°æ¸…æ™°",
                icon: "ğŸ“",
                tags: ["å­¦æœ¯", "è®ºæ–‡", "ç°åº¦", "ä¸“ä¸š"],
                previewSvg: `<svg viewBox="0 0 240 180" xmlns="http://www.w3.org/2000/svg">
                    <rect width="240" height="180" fill="#F7F9FC"/>
                    <!-- æ ‡é¢˜ -->
                    <text x="120" y="20" font-family="Arial" font-size="12" font-weight="bold" text-anchor="middle" fill="#2C3E50">(a) ç³»ç»Ÿæµç¨‹</text>
                    <!-- å¼€å§‹èŠ‚ç‚¹ -->
                    <ellipse cx="120" cy="50" rx="35" ry="20" fill="#d5e8d4" stroke="#2C3E50" stroke-width="1.5"/>
                    <text x="120" y="55" font-family="Arial" font-size="10" text-anchor="middle" fill="#2C3E50">å¼€å§‹</text>
                    <!-- å¤„ç†èŠ‚ç‚¹ -->
                    <rect x="85" y="85" width="70" height="35" rx="5" fill="#dae8fc" stroke="#2C3E50" stroke-width="1.5"/>
                    <text x="120" y="107" font-family="Arial" font-size="10" text-anchor="middle" fill="#2C3E50">æ•°æ®å¤„ç†</text>
                    <!-- ç»“æŸèŠ‚ç‚¹ -->
                    <ellipse cx="120" cy="150" rx="35" ry="20" fill="#d5e8d4" stroke="#2C3E50" stroke-width="1.5"/>
                    <text x="120" y="155" font-family="Arial" font-size="10" text-anchor="middle" fill="#2C3E50">ç»“æŸ</text>
                    <!-- è¿çº¿ -->
                    <path d="M 120 70 L 120 85" stroke="#2C3E50" stroke-width="1.5" fill="none" marker-end="url(#arrowhead)"/>
                    <path d="M 120 120 L 120 130" stroke="#2C3E50" stroke-width="1.5" fill="none" marker-end="url(#arrowhead)"/>
                    <!-- ç®­å¤´å®šä¹‰ -->
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                            <polygon points="0 0, 10 3, 0 6" fill="#2C3E50"/>
                        </marker>
                    </defs>
                </svg>`,
                systemPrompt: `ä½ æ˜¯ draw.io å›¾è¡¨ä»£ç ç”Ÿæˆå™¨ã€‚ç›´æ¥è¾“å‡ºç¬¦åˆé¡¶çº§å­¦æœ¯ä¼šè®®æ ‡å‡†çš„ mxGraph XML ä»£ç ã€‚

## è¾“å‡ºè§„åˆ™
1. åªè¾“å‡º XML ä»£ç ï¼Œç¦æ­¢ä»»ä½•æ–‡å­—è¯´æ˜
2. ä¸ä½¿ç”¨ markdown æ ‡è®°ï¼ˆå¦‚ \\\`\\\`\\\`xmlï¼‰
3. ä» <mxfile> å¼€å§‹ï¼Œåˆ° </mxfile> ç»“æŸ
4. å®Œæ•´ç”Ÿæˆæ‰€æœ‰å…ƒç´ ï¼Œä¸ä¸­é€”åœæ­¢
5. æ¥è¿‘é•¿åº¦é™åˆ¶æ—¶ï¼Œä¼˜å…ˆé—­åˆæ ‡ç­¾
6. é‡‡ç”¨æ¸è¿›å¼ï¼šæ ¸å¿ƒç»“æ„ä¼˜å…ˆï¼Œç„¶åç»†èŠ‚
7. ç¡®ä¿ XML æœ‰æ•ˆï¼Œç‰¹æ®Šå­—ç¬¦è½¬ä¹‰

## å­¦æœ¯è®ºæ–‡ç»˜å›¾è§„èŒƒï¼ˆé¡¶ä¼šæ ‡å‡†ï¼‰

### 1. å­—ä½“è¦æ±‚
- **å­—ä½“**ï¼šArial æˆ– Helveticaï¼ˆæ— è¡¬çº¿å­—ä½“ï¼‰ã€‚å¿…é¡»åœ¨ style ä¸­æ˜¾å¼æŒ‡å®š fontFamily=Arial;ã€‚
- **å­—å·**ï¼š
  - æ ‡é¢˜ï¼ˆå¦‚å›¾ (a) (b)ï¼‰ï¼š14-16pt
  - æ­£æ–‡æ ‡æ³¨ï¼ˆèŠ‚ç‚¹å†…æ–‡å­—ï¼‰ï¼š10-12pt
  - å›¾ä¾‹è¯´æ˜ï¼š9-10pt
- **å­—é‡**ï¼šnormalï¼ˆé¿å…è¿‡ç²—æˆ–è¿‡ç»†ï¼‰ã€‚

### 2. é¢œè‰²è§„èŒƒï¼ˆå­¦æœ¯æ ‡å‡†ï¼‰
- **ä¸»è‰²è°ƒ**ï¼šä¼˜å…ˆä½¿ç”¨**æ–¹æ¡ˆ1ï¼šç°åº¦ç³»**ï¼ˆ#F7F9FC, #2C3E50ï¼‰ï¼Œç¡®ä¿é»‘ç™½æ‰“å°æ¸…æ™°ã€‚
- **è¯­ä¹‰é…è‰²**ï¼šä»…åœ¨éœ€è¦åŒºåˆ†ä¸åŒè¯­ä¹‰æ—¶ï¼Œæ‰ä½¿ç”¨**æ–¹æ¡ˆ2ï¼šè“è‰²ç³»**ï¼ˆ#dae8fcï¼‰æˆ–**æ–¹æ¡ˆ5ï¼šçº¢è‰²ç³»**ï¼ˆ#f8ceccï¼Œç”¨äºè¡¨ç¤ºé”™è¯¯/ç“¶é¢ˆï¼‰ã€‚
- **è‰²ç›²å‹å¥½**ï¼šé¿å…çº¢ç»¿ç»„åˆï¼Œä½¿ç”¨è“æ©™ç»„åˆã€‚
- **å¯¹æ¯”åº¦**ï¼šæ–‡å­—ä¸èƒŒæ™¯å¯¹æ¯”åº¦ â‰¥ 4.5:1ã€‚

### 3. çº¿æ¡è§„èŒƒ
- **çº¿å®½**ï¼šstrokeWidth=1 æˆ– 2ï¼ˆé‡è¦è¿æ¥ç”¨ 2ï¼‰ã€‚
- **çº¿å‹**ï¼šå®çº¿ï¼ˆdashed=0ï¼‰ä¸ºä¸»ï¼Œè™šçº¿ï¼ˆdashed=1ï¼‰è¡¨ç¤ºè¾…åŠ©å…³ç³»æˆ–å¼‚æ­¥ã€‚
- **ç®­å¤´**ï¼šå¿…é¡»ä½¿ç”¨ç®€æ´ã€æ¸…æ™°çš„å®å¿ƒä¸‰è§’ç®­å¤´ã€‚åœ¨ style ä¸­æŒ‡å®š endArrow=classicBlock;html=1;ã€‚

### 4. å¸ƒå±€è¦æ±‚
- **å¯¹é½**ï¼šæ‰€æœ‰å…ƒç´ å¿…é¡»ä¸¥æ ¼å¯¹é½ã€‚åæ ‡ä½¿ç”¨ 10 çš„å€æ•°ï¼ˆgridSize="10"ï¼‰ã€‚
- **é—´è·**ï¼šå…ƒç´ é—´è·ä¿æŒä¸€è‡´ï¼Œè‡³å°‘ 40-60pxã€‚
- **ç•™ç™½**ï¼šå›¾è¡¨å››å‘¨ç•™ç™½è‡³å°‘ 10%ï¼Œä¿æŒç®€æ´ï¼Œä¸æ‹¥æŒ¤ã€‚
- **æ¯”ä¾‹**ï¼šä¿æŒ 4:3 æˆ– 16:9 çš„å®½é«˜æ¯”ã€‚

### 5. æ ‡æ³¨è§„èŒƒ
- **ç¼–å·**ï¼šå­å›¾ä½¿ç”¨ (a), (b), (c) ç¼–å·ã€‚
- **å•ä½**ï¼šå¿…é¡»æ¸…æ™°æ ‡æ³¨å•ä½ï¼ˆå¦‚ ms, MB, %ï¼‰ã€‚
- **å›¾ä¾‹**ï¼šå¤æ‚å›¾è¡¨**å¿…é¡»**åŒ…å«å›¾ä¾‹è¯´æ˜ï¼ˆLegendï¼‰ã€‚
- **ç®€æ´**ï¼šé¿å…å†—ä½™æ–‡å­—ã€‚
- **6. å¯Œæ–‡æœ¬ (Rich Text)**ï¼šå…è®¸åœ¨ value å±æ€§ä¸­ä½¿ç”¨ HTML å®ä½“ï¼ˆå¦‚ &lt;b&gt;ã€&lt;br&gt;ã€&lt;i&gt;ï¼‰æ¥å®ç°å¤šè¡Œæˆ–å¸¦æ ‡é¢˜çš„æ ‡æ³¨ã€‚
  - ç¤ºä¾‹ï¼švalue="&lt;b&gt;æ¨¡å— A&lt;/b&gt;&lt;br&gt;å¤„ç†å…³é”®æ•°æ® (10ms)"

## draw.io mxGraph XML æ ¼å¼è§„èŒƒ

### åŸºæœ¬ç»“æ„
\\\`\\\`\\\`xml
<mxfile>
  <diagram id="diagram-id" name="Page-1">
    <mxGraphModel dx="1422" dy="794" grid="1" gridSize="10">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>
        <!-- å›¾å½¢å…ƒç´  -->
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
\\\`\\\`\\\`

### å…ƒç´ ç±»å‹

#### 1) çŸ©å½¢ (Rectangle)
\\\`\\\`\\\`xml
<mxCell id="2" value="å¤„ç†æ¨¡å—" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#2C3E50;strokeWidth=2;fontSize=12;fontFamily=Arial;" vertex="1" parent="1">
  <mxGeometry x="100" y="100" width="120" height="60" as="geometry"/>
</mxCell>
\\\`\\\`\\\`

#### 2) æ¤­åœ† (Ellipse)
\\\`\\\`\\\`xml
<mxCell id="3" value="å¼€å§‹" style="ellipse;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#2C3E50;strokeWidth=2;fontSize=12;fontFamily=Arial;" vertex="1" parent="1">
  <mxGeometry x="100" y="200" width="120" height="80" as="geometry"/>
</mxCell>
\\\`\\\`\\\`

#### 3) è±å½¢ (Diamond)
\\\`\\\`\\\`xml
<mxCell id="4" value="æ•°æ®æ˜¯å¦æœ‰æ•ˆï¼Ÿ" style="rhombus;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#2C3E50;strokeWidth=2;fontSize=12;fontFamily=Arial;" vertex="1" parent="1">
  <mxGeometry x="100" y="300" width="140" height="100" as="geometry"/>
</mxCell>
\\\`\\\`\\\`

#### 4) ç®­å¤´ (Arrow)
\\\`\\\`\\\`xml
<mxCell id="5" value="æ•°æ®æµ" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#2C3E50;strokeWidth=2;fontSize=10;fontFamily=Arial;endArrow=classicBlock;" edge="1" parent="1" source="2" target="3">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>
\\\`\\\`\\\`

#### 5) æ–‡æœ¬ (Text / Annotation)
\\\`\\\`\\\`xml
<mxCell id="6" value="(a) ç³»ç»Ÿæ¦‚è§ˆ" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;fontSize=14;fontFamily=Arial;fontStyle=1;" vertex="1" parent="1">
  <mxGeometry x="100" y="40" width="100" height="30" as="geometry"/>
</mxCell>
\\\`\\\`\\\`

#### 6) å®¹å™¨/åˆ†ç»„ (Container)
<!-- é¡¶ä¼šæ¶æ„å›¾å¿…å¤‡ï¼šç”¨äºåˆ†å±‚ (Layer) æˆ–åˆ†ç»„ (Module) -->
<mxCell id="7" value="Layer 1: Presentation" style="swimlane;fontStyle=1;align=center;verticalAlign=top;startSize=30;fillColor=#F7F9FC;strokeColor=#2C3E50;fontSize=14;fontFamily=Arial;" vertex="1" parent="1">
  <mxGeometry x="50" y="450" width="400" height="200" as="geometry"/>
</mxCell>
<!-- å®¹å™¨å†…çš„å…ƒç´  (æ³¨æ„ parent="7") -->
<mxCell id="8" value="Component A" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#2C3E50;fontSize=12;fontFamily=Arial;" vertex="1" parent="7">
  <mxGeometry x="30" y="60" width="120" height="60" as="geometry"/>
</mxCell>

### å­¦æœ¯é…è‰²æ–¹æ¡ˆï¼ˆé¡¶ä¼šä¼˜é€‰ï¼‰

**æ–¹æ¡ˆ1ï¼šç°åº¦ç³»ï¼ˆé¦–é€‰ï¼Œé»‘ç™½æ‰“å°å‹å¥½ï¼‰**
- fillColor=#F7F9FC (ææµ…ç°èƒŒæ™¯)
- strokeColor=#2C3E50 (æ·±è“ç°è¾¹æ¡†/æ–‡å­—)

**æ–¹æ¡ˆ2ï¼šè“è‰²ç³»ï¼ˆç”¨äºè¯­ä¹‰åŒºåˆ†ï¼‰**
- fillColor=#dae8fc (æµ…è“)
- strokeColor=#3498DB (è“)

**æ–¹æ¡ˆ3ï¼šç»¿è‰²ç³»ï¼ˆç”¨äºè¡¨ç¤ºæˆåŠŸ/é€šè¿‡ï¼‰**
- fillColor=#d5e8d4 (æµ…ç»¿)
- strokeColor=#82b366 (ç»¿)

**æ–¹æ¡ˆ4ï¼šé»„è‰²ç³»ï¼ˆç”¨äºè¡¨ç¤ºè­¦å‘Š/å†³ç­–ï¼‰**
- fillColor=#fff2cc (æµ…é»„)
- strokeColor=#d6b656 (é»„)

**æ–¹æ¡ˆ5ï¼šçº¢è‰²ç³»ï¼ˆç”¨äºè¡¨ç¤ºé”™è¯¯/ç“¶é¢ˆ/é‡ç‚¹ï¼‰**
- fillColor=#f8cecc (æµ…çº¢)
- strokeColor=#E74C3C (çº¢)

## å›¾è¡¨ç±»å‹è§„èŒƒ

### æµç¨‹å›¾ (Flowchart)
- å¼€å§‹/ç»“æŸï¼šellipseï¼ŒfillColor=#d5e8d4
- å¤„ç†æ­¥éª¤ï¼šrounded rectangleï¼ŒfillColor=#dae8fc (æˆ– #F7F9FC)
- åˆ¤æ–­ï¼šrhombusï¼ŒfillColor=#fff2cc
- è¿æ¥ï¼šorthogonalEdgeStyleï¼ŒendArrow=classicBlock

### ç³»ç»Ÿæ¶æ„å›¾ (Architecture)
- åˆ†å±‚ï¼š**å¿…é¡»**ä½¿ç”¨ swimlane å®¹å™¨ (fillColor=#F7F9FC)
- ç»„ä»¶ï¼šrounded rectangle (fillColor=#dae8fc)
- è¿æ¥ï¼šç›´çº¿ç®­å¤´ (endArrow=classicBlock)ï¼Œæ ‡æ³¨åè®®æˆ–æ•°æ®
- å¸ƒå±€ï¼šä¸¥æ ¼åˆ†å±‚å¯¹é½

### å®éªŒæµç¨‹å›¾ (Experimental Workflow)
- æ­¥éª¤ï¼šrounded rectangle (fillColor=#F7F9FC)ï¼Œå¯ç”¨å¯Œæ–‡æœ¬ç¼–å· <b>1.</b> Step Name
- æ•°æ®ï¼šellipse (fillColor=#d5e8d4)
- å†³ç­–ç‚¹ï¼šdiamond (fillColor=#fff2cc)
- å¸ƒå±€ï¼šè‡ªä¸Šè€Œä¸‹

### å¯¹æ¯”åˆ†æå›¾ (Comparison)
- ä½¿ç”¨å¹¶åˆ—çš„ swimlane å®¹å™¨æˆ–çŸ©å½¢
- ç›¸åŒå±æ€§ä¸¥æ ¼å¯¹é½
- å·®å¼‚ç‚¹ä½¿ç”¨é¢œè‰²ï¼ˆå¦‚æ–¹æ¡ˆ2 vs æ–¹æ¡ˆ3ï¼‰æˆ–å¯Œæ–‡æœ¬ï¼ˆ<b>ï¼‰çªå‡ºæ˜¾ç¤º
- **å¿…é¡»**åŒ…å«å›¾ä¾‹

## ç¤ºä¾‹ï¼šå­¦æœ¯è®ºæ–‡æµç¨‹å›¾ï¼ˆå·²æ›´æ–°è§„èŒƒï¼‰
\\\`\\\`\\\`xml
<mxfile>
  <diagram id="academic-flow-v2" name="Page-1">
    <mxGraphModel dx="1422" dy="794" grid="1" gridSize="10">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>
        <mxCell id="2" value="å¼€å§‹" style="ellipse;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#2C3E50;strokeWidth=2;fontSize=12;fontFamily=Arial;" vertex="1" parent="1">
          <mxGeometry x="160" y="40" width="120" height="60" as="geometry"/>
        </mxCell>
        <mxCell id="3" value="æ•°æ®é‡‡é›†" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#2C3E50;strokeWidth=2;fontSize=12;fontFamily=Arial;" vertex="1" parent="1">
          <mxGeometry x="160" y="140" width="120" height="60" as="geometry"/>
        </mxCell>
        <mxCell id="4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#2C3E50;strokeWidth=2;fontFamily=Arial;endArrow=classicBlock;" edge="1" parent="1" source="2" target="3">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="5" value="&lt;b&gt;æ•°æ®é¢„å¤„ç†&lt;/b&gt;&lt;br&gt;(e.g., Filtering)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#2C3E50;strokeWidth=2;fontSize=12;fontFamily=Arial;" vertex="1" parent="1">
          <mxGeometry x="160" y="240" width="120" height="60" as="geometry"/>
        </mxCell>
        <mxCell id="6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#2C3E50;strokeWidth=2;fontFamily=Arial;endArrow=classicBlock;" edge="1" parent="1" source="3" target="5">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="7" value="ç»“æŸ" style="ellipse;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#2C3E50;strokeWidth=2;fontSize=12;fontFamily=Arial;" vertex="1" parent="1">
          <mxGeometry x="160" y="340" width="120" height="60" as="geometry"/>
        </mxCell>
        <mxCell id="8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#2C3E50;strokeWidth=2;fontFamily=Arial;endArrow=classicBlock;" edge="1" parent="1" source="5" target="7">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
\\\`\\\`\\\`

### å›¾ä¾‹å®ç°è§„èŒƒï¼ˆé¡¶ä¼šå¿…å¤‡ï¼‰
å›¾ä¾‹åº”ä½¿ç”¨ä¸€ä¸ªç‹¬ç«‹çš„"å®¹å™¨"æ¥å®ç°ï¼Œå®¹å™¨æœ¬èº« strokeColor=none;fillColor=none;ã€‚
\\\`\\\`\\\`xml
<!-- å›¾ä¾‹å®¹å™¨ (æ”¾ç½®åœ¨å›¾è¡¨ä¸€ä¾§ï¼Œå¦‚å³ä¸Šè§’) -->
<mxCell id="100" value="" style="strokeColor=none;fillColor=none;" vertex="1" parent="1">
  <mxGeometry x="400" y="40" width="150" height="100" as="geometry"/>
</mxCell>

<!-- å›¾ä¾‹é¡¹ 1: çŸ©å½¢ -->
<mxCell id="101" value="" style="rounded=1;fillColor=#dae8fc;strokeColor=#2C3E50;strokeWidth=2;" vertex="1" parent="100">
  <mxGeometry y="10" width="20" height="20" as="geometry"/>
</mxCell>
<mxCell id="102" value="å¤„ç†æ¨¡å—" style="text;html=1;align=left;verticalAlign=middle;fontSize=10;fontFamily=Arial;" vertex="1" parent="100">
  <mxGeometry x="30" y="10" width="100" height="20" as="geometry"/>
</mxCell>

<!-- å›¾ä¾‹é¡¹ 2: æ¤­åœ† -->
<mxCell id="103" value="" style="ellipse;fillColor=#d5e8d4;strokeColor=#2C3E50;strokeWidth=2;" vertex="1" parent="100">
  <mxGeometry y="40" width="20" height="20" as="geometry"/>
</mxCell>
<mxCell id="104" value="å¼€å§‹/ç»“æŸ" style="text;html=1;align=left;verticalAlign=middle;fontSize=10;fontFamily=Arial;" vertex="1" parent="100">
  <mxGeometry x="30" y="40" width="100" height="20" as="geometry"/>
</mxCell>
\\\`\\\`\\\`

## æœ€ä½³å®è·µ

1. **ç½‘æ ¼å¯¹é½**ï¼šæ‰€æœ‰åæ ‡ä½¿ç”¨ 10 çš„å€æ•°ã€‚
2. **ä¸€è‡´æ€§**ï¼šåŒç±»å…ƒç´ ä½¿ç”¨ç›¸åŒå°ºå¯¸å’Œæ ·å¼ã€‚
3. **ç®€æ´æ€§**ï¼šæœ€å°åŒ–æ–‡å­—ï¼Œç”¨ç¬¦å·å’Œå›¾ä¾‹ä»£æ›¿ã€‚
4. **ä¸“ä¸šæ€§**ï¼šä½¿ç”¨æ ‡å‡†æœ¯è¯­å’Œè§„èŒƒã€‚
5. **å¯è¯»æ€§**ï¼šç¡®ä¿é»‘ç™½æ‰“å°æ¸…æ™°ï¼ˆé¦–é€‰ç°åº¦æ–¹æ¡ˆï¼‰ã€‚
6. **ç‹¬ç«‹æ€§**ï¼šå›¾è¡¨åº”èƒ½è„±ç¦»æ­£æ–‡ç‹¬ç«‹ç†è§£ã€‚
7. **å¤„ç†æ¨¡ç³Šéœ€æ±‚**ï¼šå¦‚æœç”¨æˆ·çš„éœ€æ±‚è¿‡äºæ¨¡ç³Šï¼ˆä¾‹å¦‚ï¼š"ç”»ä¸€ä¸ªå…³äº AI çš„å›¾"ï¼‰ï¼Œåº”ä¸»åŠ¨è®¾è®¡ä¸€ä¸ªèƒ½ä»£è¡¨è¯¥ä¸»é¢˜çš„ã€é€šç”¨çš„å­¦æœ¯å›¾è¡¨ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ª"AI -> æœºå™¨å­¦ä¹  -> æ·±åº¦å­¦ä¹ "çš„ç®€å•å±‚æ¬¡å›¾ï¼‰ã€‚
8. **å¤„ç†å¤æ‚æ–‡æœ¬**ï¼šå¦‚æœè¾“å…¥æ˜¯ä¸€å¤§æ®µæ–‡ç« ï¼Œåº”å°½åŠ›æå–å…¶æ ¸å¿ƒé€»è¾‘ï¼ˆå¦‚æ­¥éª¤ã€ç»„ä»¶æˆ–å…³ç³»ï¼‰ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºæœ€åˆé€‚çš„å›¾è¡¨ç±»å‹ã€‚
9. **è¾“å‡ºæ ¼å¼**ï¼šåªè¾“å‡º XML ä»£ç ï¼Œä» <mxfile> å¼€å§‹ï¼Œåˆ° </mxfile> ç»“æŸï¼Œä¸è¦æœ‰ä»»ä½•è§£é‡Šæˆ–è¯´æ˜æ–‡å­—ï¼`
            }
            // å¯ä»¥åœ¨æ­¤æ·»åŠ æ›´å¤šæ¨¡æ¿
        ];
        let selectedFormat = 'png';     // é€‰æ‹©çš„å¯¼å‡ºæ ¼å¼

        // åˆå§‹åŒ–
        window.addEventListener('load', function() {
            editorFrame = document.getElementById('drawioEditor').contentWindow;

            // ç›‘å¬æ¥è‡ª draw.io çš„æ¶ˆæ¯
            window.addEventListener('message', function(evt) {
                if (evt.data && evt.data.length > 0) {
                    try {
                        const msg = JSON.parse(evt.data);
                        handleDrawioMessage(msg);
                    } catch(e) {
                        // å¿½ç•¥é JSON æ¶ˆæ¯
                    }
                }
            });

            console.log('åº”ç”¨å·²åˆå§‹åŒ–');
            console.log('å¯¹è¯è®°å¿†åŠŸèƒ½å·²å¯ç”¨');
        });

        // å¯ç”¨æ‰€æœ‰æ§ä»¶
        function enableControls() {
            // å¯ç”¨è¾“å…¥æ¡†
            const userInput = document.getElementById('userInput');
            userInput.disabled = false;
            userInput.placeholder = 'æè¿°ä½ æƒ³è¦çš„æµç¨‹å›¾...';

            // å¯ç”¨ç”ŸæˆæŒ‰é’®
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = false;

            // å¯ç”¨å¯¼å‡ºæŒ‰é’®
            const exportBtn = document.getElementById('exportImageBtn');
            exportBtn.disabled = false;

            // å¯ç”¨å¿«æ·æé—®æŒ‰é’®
            const quickBtns = document.querySelectorAll('.quick-question-btn');
            quickBtns.forEach(btn => {
                btn.disabled = false;
            });

            // æ›´æ–°æ¬¢è¿æ¶ˆæ¯
            const messagesDiv = document.getElementById('chatMessages');
            const welcomeMessage = messagesDiv.querySelector('.message-ai .message-content');
            if (welcomeMessage && welcomeMessage.textContent.includes('åˆå§‹åŒ–')) {
                welcomeMessage.innerHTML = `
                    ä½ å¥½ï¼æˆ‘æ˜¯ auto-drawioã€‚<br>
                    <span style="color: #28a745;">âœ… ç¼–è¾‘å™¨å·²å°±ç»ªï¼</span><br><br>
                    è¯·æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„æµç¨‹å›¾ï¼Œä¾‹å¦‚ï¼š<br>
                    â€¢ "ç”Ÿæˆä¸€ä¸ªç”¨æˆ·ç™»å½•æµç¨‹å›¾"<br>
                    â€¢ "åˆ›å»ºè®¢å•å¤„ç†æµç¨‹"<br>
                    â€¢ "è®¾è®¡æ”¯ä»˜ç³»ç»Ÿæ¶æ„å›¾"
                `;
            }

            console.log('[æ§ä»¶ç®¡ç†] æ‰€æœ‰æ§ä»¶å·²å¯ç”¨');
        }

        // ç¦ç”¨æ‰€æœ‰æ§ä»¶
        function disableControls() {
            // ç¦ç”¨è¾“å…¥æ¡†
            const userInput = document.getElementById('userInput');
            userInput.disabled = true;
            userInput.placeholder = 'ç­‰å¾…ç¼–è¾‘å™¨åˆå§‹åŒ–...';

            // ç¦ç”¨ç”ŸæˆæŒ‰é’®
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;

            // ç¦ç”¨å¯¼å‡ºæŒ‰é’®
            const exportBtn = document.getElementById('exportImageBtn');
            exportBtn.disabled = true;

            // ç¦ç”¨å¿«æ·æé—®æŒ‰é’®
            const quickBtns = document.querySelectorAll('.quick-question-btn');
            quickBtns.forEach(btn => {
                btn.disabled = true;
            });

            console.log('[æ§ä»¶ç®¡ç†] æ‰€æœ‰æ§ä»¶å·²ç¦ç”¨');
        }

        // å¤„ç† draw.io çš„æ¶ˆæ¯
        function handleDrawioMessage(msg) {
            console.log('æ”¶åˆ° draw.io æ¶ˆæ¯:', msg);

            switch(msg.event) {
                case 'init':
                    isEditorReady = true;
                    updateStatus('å°±ç»ª', 'ready');
                    enableControls();
                    console.log('Draw.io ç¼–è¾‘å™¨å·²å°±ç»ª');
                    break;

                case 'save':
                    currentXML = msg.xml;
                    addChatMessage('ai', 'å›¾è¡¨å·²æ›´æ–°');
                    break;

                case 'export':
                    if (exportingImage && msg.data) {
                        // å¯¼å‡ºå›¾ç‰‡
                        exportingImage = false;
                        downloadImage(msg.data, selectedFormat);
                    } else {
                        // å¯¼å‡º XML
                        currentXML = msg.xml;
                        console.log('å¯¼å‡ºçš„ XML:', msg.xml);
                    }
                    break;

                case 'autosave':
                    currentXML = msg.xml;
                    break;
            }
        }

        // æŒ‰ Enter å‘é€
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                generateDiagram();
            }
        }

        // å¿«æ·æé—®
        function quickQuestion(question) {
            const input = document.getElementById('userInput');
            input.value = question;
            // è‡ªåŠ¨è§¦å‘ç”Ÿæˆ
            generateDiagram();
        }

        // æ¨¡æ¿ç›¸å…³å‡½æ•°
        let currentDetailTemplate = null; // è¯¦æƒ…é¡µå½“å‰æŸ¥çœ‹çš„æ¨¡æ¿

        // æ‰“å¼€æ¨¡æ¿æµè§ˆé¡µé¢
        function openTemplateModal() {
            const modal = document.getElementById('templateModal');
            const listPage = document.getElementById('templateListPage');
            const detailPage = document.getElementById('templateDetailPage');

            // æ˜¾ç¤ºæ¨¡æ€çª—å£å’Œåˆ—è¡¨é¡µ
            modal.classList.add('show');
            listPage.style.display = 'flex';
            detailPage.style.display = 'none';

            // åˆå§‹åŒ–æ¨¡æ¿ç½‘æ ¼
            initTemplateGrid();
        }

        // å…³é—­æ¨¡æ¿æµè§ˆé¡µé¢
        function closeTemplateModal() {
            const modal = document.getElementById('templateModal');
            modal.classList.remove('show');
            currentDetailTemplate = null;
        }

        // åˆå§‹åŒ–æ¨¡æ¿ç½‘æ ¼
        function initTemplateGrid() {
            const templateGrid = document.getElementById('templateGrid');
            templateGrid.innerHTML = '';

            templates.forEach(template => {
                const card = document.createElement('div');
                card.className = 'template-card-large';
                card.setAttribute('data-template-id', template.id);
                card.onclick = () => viewTemplateDetail(template.id);

                // ç”Ÿæˆæ ‡ç­¾HTML
                const tagsHTML = template.tags
                    ? template.tags.map(tag => `<span class="template-tag-large">${tag}</span>`).join('')
                    : '';

                card.innerHTML = `
                    <div class="template-preview-large">
                        ${template.previewSvg || ''}
                    </div>
                    <div class="template-card-large-content">
                        <div class="template-card-large-header">
                            <span class="template-icon-large">${template.icon}</span>
                            <span class="template-name-large">${template.name}</span>
                        </div>
                        <div class="template-description-large">${template.description}</div>
                        ${tagsHTML ? `<div class="template-tags-large">${tagsHTML}</div>` : ''}
                    </div>
                `;

                templateGrid.appendChild(card);
            });
        }

        // æŸ¥çœ‹æ¨¡æ¿è¯¦æƒ…
        function viewTemplateDetail(templateId) {
            const template = templates.find(t => t.id === templateId);
            if (!template) return;

            currentDetailTemplate = template;

            // åˆ‡æ¢åˆ°è¯¦æƒ…é¡µ
            const listPage = document.getElementById('templateListPage');
            const detailPage = document.getElementById('templateDetailPage');

            listPage.style.display = 'none';
            detailPage.style.display = 'flex';

            // æ›´æ–°è¯¦æƒ…é¡µæ ‡é¢˜
            const detailTitle = document.getElementById('templateDetailTitle');
            detailTitle.innerHTML = `
                <span>${template.icon}</span>
                <span>${template.name}</span>
            `;

            // æ¸²æŸ“è¯¦æƒ…å†…å®¹
            renderTemplateDetail(template);
        }

        // æ¸²æŸ“æ¨¡æ¿è¯¦æƒ…
        function renderTemplateDetail(template) {
            const container = document.getElementById('templateDetailContainer');

            // ç”Ÿæˆæ ‡ç­¾HTML
            const tagsHTML = template.tags
                ? template.tags.map(tag => `<span class="template-detail-tag">${tag}</span>`).join('')
                : '';

            // ç”Ÿæˆç¤ºä¾‹å›¾ç‰‡HTMLï¼ˆå¦‚æœæœ‰ï¼‰
            let examplesHTML = '';
            if (template.examples && template.examples.length > 0) {
                const exampleItems = template.examples.map(ex => `
                    <div class="template-example-item">
                        <div class="template-example-title">${ex.title}</div>
                        <div class="template-detail-preview">
                            ${ex.previewSvg || '<img src="' + ex.image + '" class="template-example-img">'}
                        </div>
                    </div>
                `).join('');

                examplesHTML = `
                    <div class="template-detail-section">
                        <div class="template-detail-section-title">
                            ğŸ“¸ ç¤ºä¾‹æ•ˆæœ
                        </div>
                        <div class="template-example-images">
                            ${exampleItems}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = `
                <!-- æ¨¡æ¿æ¦‚è¿° -->
                <div class="template-detail-section">
                    <div class="template-detail-section-title">
                        ${template.icon} ${template.name}
                    </div>
                    ${tagsHTML ? `<div class="template-detail-tags">${tagsHTML}</div>` : ''}
                    <div class="template-detail-section-content">
                        ${template.description}
                    </div>
                    <div class="template-detail-preview">
                        ${template.previewSvg || ''}
                    </div>
                </div>

                ${examplesHTML}

                <!-- ç³»ç»Ÿæç¤ºè¯ -->
                <div class="template-detail-section">
                    <div class="template-detail-section-title">
                        ğŸ’¬ ç³»ç»Ÿæç¤ºè¯
                    </div>
                    <div class="template-detail-section-content">
                        <p style="margin-bottom: 12px; color: #6c757d;">
                            è¿™æ˜¯å‘é€ç»™AIçš„ç³»ç»Ÿæç¤ºè¯ï¼Œå®šä¹‰äº†ç”Ÿæˆå›¾è¡¨çš„é£æ ¼å’Œè§„èŒƒï¼š
                        </p>
                        <div class="template-prompt-box">${escapeHtml(template.systemPrompt)}</div>
                    </div>
                </div>
            `;
        }

        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // è¿”å›æ¨¡æ¿åˆ—è¡¨
        function backToTemplateList() {
            const listPage = document.getElementById('templateListPage');
            const detailPage = document.getElementById('templateDetailPage');

            listPage.style.display = 'flex';
            detailPage.style.display = 'none';
            currentDetailTemplate = null;
        }

        // ä»è¯¦æƒ…é¡µåº”ç”¨æ¨¡æ¿
        function applyTemplateFromDetail() {
            if (!currentDetailTemplate) return;

            // è®¾ç½®å½“å‰æ¨¡æ¿
            currentTemplate = currentDetailTemplate;

            // å…³é—­æ¨¡æ€çª—å£
            closeTemplateModal();

            // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
            addChatMessage('ai', `å·²åº”ç”¨æ¨¡æ¿ï¼š${currentTemplate.icon} ${currentTemplate.name}ã€‚ç°åœ¨æ‚¨å¯ä»¥æè¿°æƒ³è¦ç”Ÿæˆçš„æµç¨‹å›¾äº†ã€‚`);
        }

        // æ¸…é™¤æ¨¡æ¿é€‰æ‹©ï¼ˆä¿ç•™æ­¤å‡½æ•°ä»¥å…¼å®¹ï¼‰
        function clearTemplate() {
            currentTemplate = null;
            addChatMessage('ai', 'å·²æ¸…é™¤æ¨¡æ¿é€‰æ‹©ï¼Œå°†ä½¿ç”¨é»˜è®¤æ ·å¼ã€‚');
        }

        // XML æ ¼å¼éªŒè¯å‡½æ•°
        function validateXML(xmlString) {
            try {
                console.log('[XMLéªŒè¯] å¼€å§‹éªŒè¯ XML æ ¼å¼...');

                // 1. åŸºæœ¬æ£€æŸ¥ï¼šä¸èƒ½ä¸ºç©º
                if (!xmlString || xmlString.trim().length === 0) {
                    console.error('[XMLéªŒè¯] âœ— XML ä¸ºç©º');
                    return { valid: false, error: 'XML å†…å®¹ä¸ºç©º' };
                }

                // 2. å¿…é¡»åŒ…å« mxfile æ ‡ç­¾
                if (!xmlString.includes('<mxfile') && !xmlString.includes('<mxGraphModel')) {
                    console.error('[XMLéªŒè¯] âœ— ç¼ºå°‘ mxfile æˆ– mxGraphModel æ ‡ç­¾');
                    return { valid: false, error: 'ä¸æ˜¯æœ‰æ•ˆçš„ draw.io XML æ ¼å¼' };
                }

                // 3. ä½¿ç”¨ DOMParser éªŒè¯ XML è¯­æ³•
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, 'text/xml');

                // æ£€æŸ¥æ˜¯å¦æœ‰è§£æé”™è¯¯
                const parserError = xmlDoc.querySelector('parsererror');
                if (parserError) {
                    const errorText = parserError.textContent;
                    console.error('[XMLéªŒè¯] âœ— XML è§£æé”™è¯¯:', errorText);
                    return { valid: false, error: `XML è¯­æ³•é”™è¯¯: ${errorText}` };
                }

                // 4. æ£€æŸ¥å¿…è¦çš„ç»“æ„
                const mxfile = xmlDoc.querySelector('mxfile');
                const mxGraphModel = xmlDoc.querySelector('mxGraphModel');

                if (!mxfile && !mxGraphModel) {
                    console.error('[XMLéªŒè¯] âœ— ç¼ºå°‘å¿…è¦çš„ XML ç»“æ„');
                    return { valid: false, error: 'ç¼ºå°‘ mxfile æˆ– mxGraphModel å…ƒç´ ' };
                }

                console.log('[XMLéªŒè¯] âœ“ XML æ ¼å¼éªŒè¯é€šè¿‡');
                return { valid: true };

            } catch (error) {
                console.error('[XMLéªŒè¯] âœ— éªŒè¯è¿‡ç¨‹å‡ºé”™:', error);
                return { valid: false, error: `éªŒè¯å¼‚å¸¸: ${error.message}` };
            }
        }

        // ç”Ÿæˆæµç¨‹å›¾ï¼ˆæ”¯æŒè‡ªåŠ¨é‡è¯•ï¼‰
        // ç”Ÿæˆæµç¨‹å›¾ï¼ˆä½¿ç”¨æµå¼è¾“å‡ºï¼‰
        async function generateDiagram(isRetry = false, retryMessageDiv = null) {
            // æ£€æŸ¥ç¼–è¾‘å™¨æ˜¯å¦å°±ç»ª
            if (!isEditorReady) {
                alert('ç¼–è¾‘å™¨æ­£åœ¨åˆå§‹åŒ–ä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }

            const input = document.getElementById('userInput');
            const prompt = input.value.trim();

            if (!prompt) {
                alert('è¯·è¾“å…¥æµç¨‹å›¾æè¿°');
                return;
            }

            // ä¿å­˜æç¤ºè¯ï¼Œç”¨äºé‡è¯•
            lastPrompt = prompt;

            // å¦‚æœä¸æ˜¯é‡è¯•ï¼Œæ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            if (!isRetry) {
                addChatMessage('user', prompt);
                input.value = '';
            }

            // åˆ›å»ºæˆ–å¤ç”¨æµå¼è¾“å‡ºæ¶ˆæ¯æ¡†
            let streamMessageDiv = null;
            if (isRetry && retryMessageDiv) {
                // é‡è¯•ï¼šå¤ç”¨ç°æœ‰æ¶ˆæ¯æ¡†ï¼Œæ¸…ç©ºå†…å®¹å’ŒæŒ‰é’®
                streamMessageDiv = retryMessageDiv;
                clearStreamContent(streamMessageDiv);
                // ç§»é™¤é‡è¯•æŒ‰é’®
                const retryBtn = streamMessageDiv.querySelector('.retry-button');
                if (retryBtn) {
                    retryBtn.remove();
                }
                // éšè—çŠ¶æ€æ 
                const statusDiv = streamMessageDiv.querySelector('.stream-status');
                if (statusDiv) {
                    statusDiv.style.display = 'none';
                    statusDiv.textContent = '';
                }
            }
            // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œåˆ›å»ºæ–°æ¶ˆæ¯æ¡†ï¼Œç­‰æ”¶åˆ°ç¬¬ä¸€ä¸ªå†…å®¹æ—¶å†åˆ›å»º

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            updateStatus('ç”Ÿæˆä¸­...', 'loading');
            showLoading(true);

            try {
                // æ„å»ºè¯·æ±‚ä½“
                const requestBody = {
                    prompt: prompt,
                    messages: conversationHistory,
                    skip_apis: failedAPIs
                };

                // å¦‚æœé€‰æ‹©äº†æ¨¡æ¿ï¼Œæ·»åŠ è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯
                if (currentTemplate && currentTemplate.systemPrompt) {
                    requestBody.system_prompt = currentTemplate.systemPrompt;
                }

                const response = await fetch('/api/generate-diagram-stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error('ç”Ÿæˆå¤±è´¥');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let fullXML = '';

                while (true) {
                    const { done, value } = await reader.read();

                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // ä¿ç•™æœ€åä¸å®Œæ•´çš„è¡Œ

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.slice(6));

                            if (data.type === 'start') {
                                // å¼€å§‹æ–°çš„æµå¼è¾“å‡º
                            } else if (data.type === 'content') {
                                // æ”¶åˆ°ç¬¬ä¸€ä¸ªå†…å®¹æ—¶æ‰åˆ›å»ºæ¶ˆæ¯æ¡†
                                if (!streamMessageDiv) {
                                    streamMessageDiv = createStreamMessage();
                                }
                                fullXML += data.content;
                                appendStreamContent(streamMessageDiv, data.content);
                            } else if (data.type === 'validation_failed') {
                                // ç¡®ä¿æœ‰æ¶ˆæ¯æ¡†
                                if (!streamMessageDiv) {
                                    streamMessageDiv = createStreamMessage();
                                }
                                // éªŒè¯å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯å’Œé‡è¯•æŒ‰é’®
                                updateStreamMessage(streamMessageDiv, `âŒ ${data.message}`, false, true);
                                addRetryButton(streamMessageDiv);
                                lastFailedMessageDiv = streamMessageDiv; // ä¿å­˜å¤±è´¥çš„æ¶ˆæ¯æ¡†
                                updateStatus('éªŒè¯å¤±è´¥', 'ready');
                                showLoading(false);
                                return;
                            } else if (data.type === 'processing') {
                                // å¤„ç†ä¸­ï¼Œä¸æ˜¾ç¤ºé¢å¤–æç¤º
                            } else if (data.type === 'complete') {
                                // ç¡®ä¿æœ‰æ¶ˆæ¯æ¡†
                                if (!streamMessageDiv) {
                                    streamMessageDiv = createStreamMessage();
                                }
                                // ç”Ÿæˆå®Œæˆ
                                currentXML = data.xml;
                                conversationHistory = data.messages;

                                // æ ‡è®°æµå¼æ¶ˆæ¯ä¸ºå®ŒæˆçŠ¶æ€ï¼ˆä¸åˆ é™¤ï¼‰
                                updateStreamMessage(streamMessageDiv, 'âœ… ç”Ÿæˆå®Œæˆï¼XML å·²åŠ è½½åˆ°ç¼–è¾‘å™¨', true);

                                // åŠ è½½åˆ°ç¼–è¾‘å™¨
                                loadXMLToEditor(data.xml);
                                updateStatus('å°±ç»ª', 'ready');
                                showLoading(false);
                                return;
                            } else if (data.type === 'error' || data.type === 'failed') {
                                // ç¡®ä¿æœ‰æ¶ˆæ¯æ¡†
                                if (!streamMessageDiv) {
                                    streamMessageDiv = createStreamMessage();
                                }
                                updateStreamMessage(streamMessageDiv, `âŒ ${data.message}`, false, true);
                                addRetryButton(streamMessageDiv);
                                lastFailedMessageDiv = streamMessageDiv; // ä¿å­˜å¤±è´¥çš„æ¶ˆæ¯æ¡†
                                updateStatus('é”™è¯¯', 'ready');
                                showLoading(false);
                                return;
                            }
                        }
                    }
                }

            } catch (error) {
                console.error('ç”Ÿæˆå¤±è´¥:', error);
                // ç¡®ä¿æœ‰æ¶ˆæ¯æ¡†
                if (!streamMessageDiv) {
                    streamMessageDiv = createStreamMessage();
                }
                if (streamMessageDiv && streamMessageDiv.parentNode) {
                    updateStreamMessage(streamMessageDiv, 'âŒ ç½‘ç»œé”™è¯¯æˆ–è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•', false, true);
                    addRetryButton(streamMessageDiv);
                    lastFailedMessageDiv = streamMessageDiv; // ä¿å­˜å¤±è´¥çš„æ¶ˆæ¯æ¡†
                }
                updateStatus('é”™è¯¯', 'ready');
                showLoading(false);
            }
        }

        // åˆ›å»ºæµå¼è¾“å‡ºæ¶ˆæ¯æ¡†
        function createStreamMessage() {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message message-ai';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            const statusDiv = document.createElement('div');
            statusDiv.className = 'stream-status';
            statusDiv.style.display = 'none';  // åˆå§‹éšè—çŠ¶æ€æ 
            statusDiv.textContent = '';

            const outputDiv = document.createElement('div');
            outputDiv.className = 'stream-output';
            outputDiv.textContent = '';

            contentDiv.appendChild(statusDiv);
            contentDiv.appendChild(outputDiv);
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            return messageDiv;
        }

        // æ›´æ–°æµå¼æ¶ˆæ¯çŠ¶æ€
        function updateStreamMessage(messageDiv, status, isCompleted = false, isError = false) {
            const statusDiv = messageDiv.querySelector('.stream-status');
            if (statusDiv) {
                statusDiv.textContent = status;

                // ç§»é™¤ä¹‹å‰çš„çŠ¶æ€ç±»
                statusDiv.classList.remove('completed', 'error');

                // åªåœ¨å®Œæˆæˆ–é”™è¯¯æ—¶æ˜¾ç¤ºçŠ¶æ€æ 
                if (isCompleted || isError) {
                    statusDiv.style.display = 'block';

                    // æ·»åŠ æ–°çš„çŠ¶æ€ç±»
                    if (isCompleted) {
                        statusDiv.classList.add('completed');
                    } else if (isError) {
                        statusDiv.classList.add('error');
                    }
                }
            }
        }

        // è¿½åŠ æµå¼å†…å®¹
        function appendStreamContent(messageDiv, content) {
            const outputDiv = messageDiv.querySelector('.stream-output');
            if (outputDiv) {
                outputDiv.textContent += content;
                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                outputDiv.scrollTop = outputDiv.scrollHeight;
            }
        }

        // æ¸…ç©ºæµå¼å†…å®¹
        function clearStreamContent(messageDiv) {
            const outputDiv = messageDiv.querySelector('.stream-output');
            if (outputDiv) {
                outputDiv.textContent = '';
            }
        }

        // æ·»åŠ é‡è¯•æŒ‰é’®
        function addRetryButton(messageDiv) {
            const contentDiv = messageDiv.querySelector('.message-content');
            if (!contentDiv) return;

            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰é‡è¯•æŒ‰é’®
            if (contentDiv.querySelector('.retry-button')) return;

            // åˆ›å»ºé‡è¯•æŒ‰é’®
            const retryBtn = document.createElement('button');
            retryBtn.className = 'btn btn-primary retry-button';
            retryBtn.style.cssText = 'margin-top: 10px; padding: 8px 16px; font-size: 13px;';
            retryBtn.textContent = 'ğŸ”„ é‡æ–°ç”Ÿæˆ';
            retryBtn.onclick = function() {
                retryGeneration();
            };

            contentDiv.appendChild(retryBtn);

            // æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œç¡®ä¿æŒ‰é’®å¯è§
            scrollToBottom();
        }

        // é‡è¯•ç”Ÿæˆ
        function retryGeneration() {
            if (!lastPrompt) {
                alert('æ²¡æœ‰å¯é‡è¯•çš„è¯·æ±‚');
                return;
            }

            if (!lastFailedMessageDiv) {
                alert('æ‰¾ä¸åˆ°å¤±è´¥çš„æ¶ˆæ¯æ¡†');
                return;
            }

            console.log('[é‡è¯•] ä½¿ç”¨æç¤ºè¯:', lastPrompt);
            console.log('[é‡è¯•] å¤ç”¨æ¶ˆæ¯æ¡†ï¼Œä¸æ·»åŠ æ–°çš„ç”¨æˆ·æ¶ˆæ¯');

            // ä¸´æ—¶è®¾ç½®è¾“å…¥æ¡†çš„å€¼ï¼Œä½†ä¸æ˜¾ç¤ºç»™ç”¨æˆ·
            const input = document.getElementById('userInput');
            const originalValue = input.value;
            input.value = lastPrompt;

            // è°ƒç”¨ç”Ÿæˆå‡½æ•°ï¼Œä¼ å…¥é‡è¯•æ ‡å¿—å’Œå¤±è´¥çš„æ¶ˆæ¯æ¡†
            generateDiagram(true, lastFailedMessageDiv);

            // æ¢å¤è¾“å…¥æ¡†åŸæ¥çš„å€¼
            input.value = originalValue;
        }

        // åŠ è½½ XML åˆ°ç¼–è¾‘å™¨
        function loadXMLToEditor(xml) {
            if (!isEditorReady) {
                alert('ç¼–è¾‘å™¨æ­£åœ¨åˆå§‹åŒ–ä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }

            // éšè—ç©ºçŠ¶æ€
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('drawioEditor').style.display = 'block';

            // å‘é€åŠ è½½å‘½ä»¤
            const message = JSON.stringify({
                action: 'load',
                xml: xml,
                autosave: 1
            });

            editorFrame.postMessage(message, '*');
            console.log('XML å·²åŠ è½½åˆ°ç¼–è¾‘å™¨');
        }

        // ä¿å­˜æµç¨‹å›¾
        async function saveDiagram() {
            if (!currentXML) {
                alert('è¿˜æ²¡æœ‰å›¾è¡¨å¯ä»¥ä¿å­˜');
                return;
            }

            // å…ˆå¯¼å‡ºå½“å‰å›¾è¡¨
            editorFrame.postMessage(JSON.stringify({action: 'export', format: 'xml'}), '*');

            // ç­‰å¾…ä¸€ä¸‹è®© export å®Œæˆ
            setTimeout(async () => {
                try {
                    const response = await fetch('/api/save-diagram', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ xml: currentXML })
                    });

                    const data = await response.json();
                    addChatMessage('ai', `ä¿å­˜æˆåŠŸï¼å›¾è¡¨ ID: ${data.id}`);
                } catch (error) {
                    console.error('ä¿å­˜å¤±è´¥:', error);
                    addChatMessage('ai', 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
                }
            }, 500);
        }

        // å¯¼å‡ºå›¾è¡¨
        function exportDiagram() {
            if (!currentXML) {
                alert('è¿˜æ²¡æœ‰å›¾è¡¨å¯ä»¥å¯¼å‡º');
                return;
            }

            // å¯¼å‡ºä¸º XML æ–‡ä»¶
            const blob = new Blob([currentXML], { type: 'text/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'diagram.drawio';
            a.click();
            URL.revokeObjectURL(url);

            addChatMessage('ai', 'å›¾è¡¨å·²å¯¼å‡ºä¸º .drawio æ–‡ä»¶');
        }

        // å¯¼å‡ºå›¾ç‰‡ - æ‰“å¼€æ ¼å¼é€‰æ‹©å™¨
        function exportAsImage() {
            if (!isEditorReady) {
                alert('ç¼–è¾‘å™¨æ­£åœ¨åˆå§‹åŒ–ä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }

            if (!currentXML) {
                alert('è¿˜æ²¡æœ‰å›¾è¡¨å¯ä»¥å¯¼å‡º');
                return;
            }

            // æ˜¾ç¤ºæ ¼å¼é€‰æ‹©å™¨
            document.getElementById('formatOverlay').classList.add('active');
            document.getElementById('formatSelector').classList.add('active');
        }

        // é€‰æ‹©æ ¼å¼
        function selectFormat(format) {
            selectedFormat = format;
            document.getElementById('formatPNG').checked = (format === 'png');
            document.getElementById('formatJPG').checked = (format === 'jpg');
            document.getElementById('formatSVG').checked = (format === 'svg');
        }

        // å…³é—­æ ¼å¼é€‰æ‹©å™¨
        function closeFormatSelector() {
            document.getElementById('formatOverlay').classList.remove('active');
            document.getElementById('formatSelector').classList.remove('active');
        }

        // ç¡®è®¤å¯¼å‡º
        function confirmExport() {
            // å…³é—­é€‰æ‹©å™¨
            closeFormatSelector();

            // è®¾ç½®å¯¼å‡ºæ ‡å¿—
            exportingImage = true;

            // å‘é€å¯¼å‡ºå‘½ä»¤åˆ° draw.io
            const message = JSON.stringify({
                action: 'export',
                format: selectedFormat,
                spin: 'Exporting...'
            });

            editorFrame.postMessage(message, '*');
            console.log(`æ­£åœ¨å¯¼å‡º ${selectedFormat.toUpperCase()} å›¾ç‰‡...`);
        }

        // ä¸‹è½½å›¾ç‰‡
        function downloadImage(data, format) {
            try {
                const link = document.createElement('a');

                if (format === 'svg') {
                    // SVG æ ¼å¼å¤„ç†
                    const blob = new Blob([data], { type: 'image/svg+xml' });
                    link.href = URL.createObjectURL(blob);
                } else {
                    // PNG/JPG æ ¼å¼å¤„ç†ï¼ˆbase64ï¼‰
                    // æ£€æŸ¥æ˜¯å¦å·²ç»åŒ…å« data URL å‰ç¼€
                    if (!data.startsWith('data:')) {
                        // å¦‚æœæ²¡æœ‰å‰ç¼€ï¼Œæ·»åŠ æ­£ç¡®çš„ MIME ç±»å‹
                        const mimeType = format === 'png' ? 'image/png' : 'image/jpeg';
                        data = `data:${mimeType};base64,${data}`;
                    }

                    // å°† base64 è½¬æ¢ä¸º Blobï¼ˆæ›´é€‚åˆå¤§æ–‡ä»¶ï¼‰
                    try {
                        const base64Data = data.split(',')[1];
                        const byteCharacters = atob(base64Data);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        const mimeType = format === 'png' ? 'image/png' : 'image/jpeg';
                        const blob = new Blob([byteArray], { type: mimeType });
                        link.href = URL.createObjectURL(blob);
                    } catch (e) {
                        // å¦‚æœè½¬æ¢å¤±è´¥ï¼Œç›´æ¥ä½¿ç”¨ data URL
                        console.warn('Blob è½¬æ¢å¤±è´¥ï¼Œä½¿ç”¨ data URL:', e);
                        link.href = data;
                    }
                }

                link.download = `diagram_${Date.now()}.${format}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // æ¸…ç† URL å¯¹è±¡
                if (link.href.startsWith('blob:')) {
                    setTimeout(() => URL.revokeObjectURL(link.href), 100);
                }

                console.log(`${format.toUpperCase()} å›¾ç‰‡å·²ä¸‹è½½`);
            } catch (error) {
                console.error('ä¸‹è½½å›¾ç‰‡å¤±è´¥:', error);
                alert('ä¸‹è½½å›¾ç‰‡å¤±è´¥: ' + error.message);
            }
        }

        // å¯¼å…¥å›¾è¡¨
        function importDiagram() {
            const fileInput = document.getElementById('fileInput');
            fileInput.click();
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.xml') && !fileName.endsWith('.drawio')) {
                alert('è¯·é€‰æ‹© .xml æˆ– .drawio æ–‡ä»¶');
                return;
            }

            // è¯»å–æ–‡ä»¶å†…å®¹
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const xml = e.target.result;

                    console.log('å¯¼å…¥çš„ XML é•¿åº¦:', xml.length, 'å­—ç¬¦');

                    // åŠ è½½åˆ°ç¼–è¾‘å™¨
                    loadXMLToEditor(xml);

                    // å°†å¯¼å…¥çš„ XML æ·»åŠ åˆ°å¯¹è¯å†å²ï¼ˆä½œä¸ºåˆå§‹ä¸Šä¸‹æ–‡ï¼‰
                    conversationHistory = [
                        {
                            role: 'user',
                            content: 'æˆ‘å¯¼å…¥äº†ä¸€ä¸ªæµç¨‹å›¾ï¼Œè¯·å¸®æˆ‘ç†è§£å®ƒçš„ç»“æ„'
                        },
                        {
                            role: 'assistant',
                            content: xml
                        }
                    ];

                    console.log('å¯¹è¯å†å²å·²åˆå§‹åŒ–ï¼Œé•¿åº¦:', conversationHistory.length);

                    // æ·»åŠ  AI æ¶ˆæ¯
                    addChatMessage('ai', `å·²å¯¼å…¥æ–‡ä»¶ï¼š${file.name}ã€‚ä½ ç°åœ¨å¯ä»¥åŸºäºè¿™ä¸ªæµç¨‹å›¾è¿›è¡Œä¿®æ”¹ï¼Œä¾‹å¦‚ï¼š"æŠŠæŸä¸ªæ¡†æ”¹å¤§ä¸€ç‚¹"ã€"æ·»åŠ ä¸€ä¸ªæ–°æ­¥éª¤"ç­‰ã€‚`);

                    // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤å¯¼å…¥åŒä¸€æ–‡ä»¶
                    event.target.value = '';

                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥:', error);
                    alert('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®');
                }
            };

            reader.onerror = function() {
                alert('æ–‡ä»¶è¯»å–å¤±è´¥');
            };

            reader.readAsText(file);
        }

        // æ·»åŠ èŠå¤©æ¶ˆæ¯
        function addChatMessage(type, content) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;

            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            scrollToBottom();
        }

        // æ»šåŠ¨èŠå¤©åŒºåˆ°åº•éƒ¨
        function scrollToBottom() {
            const messagesDiv = document.getElementById('chatMessages');
            // ä½¿ç”¨ setTimeout ç¡®ä¿ DOM æ›´æ–°åå†æ»šåŠ¨
            setTimeout(() => {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 0);
        }

        // æ–°å»ºä¼šè¯
        function newConversation() {
            // æ¸…ç©ºå¯¹è¯å†å²
            conversationHistory = [];
            lastPrompt = null;
            lastFailedXML = null;
            lastValidationError = null;
            failedAPIs = [];
            lastUsedAPI = null;
            lastFailedMessageDiv = null;
            currentXML = null;

            // æ¸…ç©ºèŠå¤©æ¶ˆæ¯
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.innerHTML = '';

            // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
            const welcomeDiv = document.createElement('div');
            welcomeDiv.className = 'message message-ai';
            welcomeDiv.innerHTML = `
                <div class="message-content">
                    ä½ å¥½ï¼æˆ‘æ˜¯ auto-drawioã€‚<br>
                    è¯·æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„æµç¨‹å›¾ï¼Œä¾‹å¦‚ï¼š<br>
                    â€¢ "ç”Ÿæˆä¸€ä¸ªç”¨æˆ·ç™»å½•æµç¨‹å›¾"<br>
                    â€¢ "åˆ›å»ºè®¢å•å¤„ç†æµç¨‹"<br>
                    â€¢ "è®¾è®¡æ”¯ä»˜ç³»ç»Ÿæ¶æ„å›¾"
                </div>
            `;
            messagesDiv.appendChild(welcomeDiv);

            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('userInput').value = '';

            // æ¸…ç©º Draw.io ç¼–è¾‘å™¨
            document.getElementById('drawioEditor').style.display = 'none';
            document.getElementById('emptyState').style.display = 'flex';

            // é‡ç½®çŠ¶æ€
            updateStatus('å°±ç»ª', 'ready');

            console.log('[æ–°å»ºä¼šè¯] ä¼šè¯å·²é‡ç½®');
        }

        // æ·»åŠ å¸¦æœ‰äº¤äº’å¼é€‰é¡¹çš„å¤±è´¥æ¶ˆæ¯
        function addFailureMessage(errorMessage, retriesAttempted) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message message-ai';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            // åˆ›å»ºé”™è¯¯æ¶ˆæ¯æ–‡æœ¬
            const errorText = document.createElement('div');
            errorText.innerHTML = `
                <strong>âŒ ç”Ÿæˆå¤±è´¥</strong><br>
                <span style="color: #dc3545;">${errorMessage}</span><br>
                <small>å·²è‡ªåŠ¨é‡è¯• ${retriesAttempted} æ¬¡</small>
            `;
            contentDiv.appendChild(errorText);

            // åˆ›å»ºæ“ä½œæŒ‰é’®åŒºåŸŸ
            const actionsDiv = document.createElement('div');
            actionsDiv.style.cssText = 'margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;';

            // æ‰‹åŠ¨é‡è¯•æŒ‰é’®
            const retryBtn = document.createElement('button');
            retryBtn.textContent = 'ğŸ”„ æ‰‹åŠ¨é‡è¯•';
            retryBtn.style.cssText = 'padding: 6px 12px; border: none; border-radius: 4px; background: #007bff; color: white; cursor: pointer; font-size: 12px;';
            retryBtn.onclick = function() {
                console.log('[æ‰‹åŠ¨é‡è¯•] ç”¨æˆ·ç‚¹å‡»æ‰‹åŠ¨é‡è¯•');
                manualRetry();
            };

            // æŸ¥çœ‹é”™è¯¯è¯¦æƒ…æŒ‰é’®
            const detailsBtn = document.createElement('button');
            detailsBtn.textContent = 'ğŸ” é”™è¯¯è¯¦æƒ…';
            detailsBtn.style.cssText = 'padding: 6px 12px; border: none; border-radius: 4px; background: #6c757d; color: white; cursor: pointer; font-size: 12px;';
            detailsBtn.onclick = function() {
                console.log('[é”™è¯¯è¯¦æƒ…] ç”¨æˆ·ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…');
                viewErrorDetails();
            };

            // ä¸‹è½½å¤±è´¥ XML æŒ‰é’®
            const downloadBtn = document.createElement('button');
            downloadBtn.textContent = 'ğŸ“¥ ä¸‹è½½å¤±è´¥çš„XML';
            downloadBtn.style.cssText = 'padding: 6px 12px; border: none; border-radius: 4px; background: #28a745; color: white; cursor: pointer; font-size: 12px;';
            downloadBtn.onclick = function() {
                console.log('[ä¸‹è½½XML] ç”¨æˆ·ç‚¹å‡»ä¸‹è½½å¤±è´¥çš„XML');
                downloadFailedXML();
            };

            // æ·»åŠ æŒ‰é’®
            actionsDiv.appendChild(retryBtn);
            actionsDiv.appendChild(detailsBtn);
            actionsDiv.appendChild(downloadBtn);

            contentDiv.appendChild(actionsDiv);
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // æ‰‹åŠ¨é‡è¯•ç”Ÿæˆ
        function manualRetry() {
            if (!lastPrompt) {
                alert('æ— æ³•é‡è¯•ï¼šæœªæ‰¾åˆ°ä¸Šæ¬¡çš„æç¤ºè¯');
                return;
            }

            console.log('[æ‰‹åŠ¨é‡è¯•] ä½¿ç”¨æç¤ºè¯:', lastPrompt);
            console.log('[æ‰‹åŠ¨é‡è¯•] é‡ç½®å¤±è´¥ API åˆ—è¡¨');

            // é‡ç½®å¤±è´¥ API åˆ—è¡¨ï¼ˆç»™æ–°ä¸€è½®å°è¯•æ‰€æœ‰ API çš„æœºä¼šï¼‰
            failedAPIs = [];

            addChatMessage('user', `[æ‰‹åŠ¨é‡è¯•] ${lastPrompt}`);

            // è®¾ç½®è¾“å…¥æ¡†çš„å€¼ä¸ºä¸Šæ¬¡çš„æç¤ºè¯ï¼Œç„¶åè°ƒç”¨ç”Ÿæˆå‡½æ•°
            const input = document.getElementById('userInput');
            input.value = lastPrompt;
            generateDiagram(0);  // ä»å¤´å¼€å§‹ï¼ŒretryCount = 0
        }

        // æŸ¥çœ‹é”™è¯¯è¯¦æƒ…
        function viewErrorDetails() {
            if (!lastValidationError || !lastFailedXML) {
                alert('æ²¡æœ‰å¯ç”¨çš„é”™è¯¯è¯¦æƒ…');
                return;
            }

            // åˆ›å»ºè¯¦æƒ…æ¶ˆæ¯
            const xmlPreview = lastFailedXML.substring(0, 500);  // åªæ˜¾ç¤ºå‰ 500 å­—ç¬¦
            const detailsText = `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ é”™è¯¯è¯¦æƒ…
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âŒ é”™è¯¯ç±»å‹ï¼š
${lastValidationError}

ğŸ“„ XML é¢„è§ˆï¼ˆå‰ 500 å­—ç¬¦ï¼‰ï¼š
${xmlPreview}...

ğŸ’¡ å¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼š
1. å°è¯•æ‰‹åŠ¨é‡è¯•ï¼ˆå¯èƒ½æ˜¯ä¸´æ—¶é”™è¯¯ï¼‰
2. ä¿®æ”¹æè¿°ï¼Œä½¿ç”¨æ›´ç®€å•çš„è¡¨è¿°
3. ä¸‹è½½å¤±è´¥çš„ XML æä¾›ç»™å¼€å‘è€…è°ƒè¯•
            `.trim();

            addChatMessage('ai', detailsText);
        }

        // ä¸‹è½½å¤±è´¥çš„ XML
        function downloadFailedXML() {
            if (!lastFailedXML) {
                alert('æ²¡æœ‰å¤±è´¥çš„ XML å¯ä¸‹è½½');
                return;
            }

            try {
                const blob = new Blob([lastFailedXML], { type: 'text/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `failed_diagram_${Date.now()}.xml`;
                a.click();
                URL.revokeObjectURL(url);

                addChatMessage('ai', 'âœ… å¤±è´¥çš„ XML å·²ä¸‹è½½ï¼Œæ–‡ä»¶ååŒ…å«æ—¶é—´æˆ³');
            } catch (error) {
                console.error('[ä¸‹è½½å¤±è´¥]', error);
                alert('ä¸‹è½½å¤±è´¥ï¼š' + error.message);
            }
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(text, status) {
            const badge = document.getElementById('statusBadge');
            badge.textContent = text;
            badge.className = `status-badge status-${status}`;
        }

        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        function showLoading(show) {
            const loading = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');

            if (show) {
                loading.classList.add('active');
                // ç”Ÿæˆæ—¶éšè—ç©ºçŠ¶æ€æç¤º
                emptyState.style.display = 'none';
            } else {
                loading.classList.remove('active');
                // å¦‚æœæ²¡æœ‰å›¾è¡¨ï¼Œé‡æ–°æ˜¾ç¤ºç©ºçŠ¶æ€æç¤º
                const editor = document.getElementById('drawioEditor');
                if (editor.style.display === 'none') {
                    emptyState.style.display = 'flex';
                }
            }
        }

        // ========== AI é…ç½®ç®¡ç†åŠŸèƒ½ ==========

        // æ‰“å¼€è®¾ç½®æ¨¡æ€æ¡†
        async function openSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.add('active');
            await loadConfigs();
        }

        // å…³é—­è®¾ç½®æ¨¡æ€æ¡†
        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.remove('active');
            closeConfigForm();
        }

        // ä»åç«¯åŠ è½½é…ç½®åˆ—è¡¨
        async function loadConfigs() {
            try {
                const response = await fetch('/api/ai-configs');
                const data = await response.json();

                if (data.success) {
                    renderConfigList(data.configs);
                } else {
                    throw new Error('åŠ è½½é…ç½®å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                document.getElementById('configList').innerHTML =
                    '<p style="text-align: center; color: #dc3545;">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡</p>';
            }
        }

        // æ¸²æŸ“é…ç½®åˆ—è¡¨
        function renderConfigList(configs) {
            const listContainer = document.getElementById('configList');

            if (configs.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: #6c757d;">è¿˜æ²¡æœ‰é…ç½®ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </p>';
                return;
            }

            listContainer.innerHTML = configs.map(config => `
                <div class="config-item">
                    <div class="config-header">
                        <div>
                            <span class="config-name">${escapeHtml(config.name)}</span>
                            <span class="config-status ${config.enabled ? 'config-enabled' : 'config-disabled'}">
                                ${config.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}
                            </span>
                        </div>
                        <div class="config-actions">
                            <button class="btn btn-small btn-secondary" onclick="editConfig('${config.id}')">
                                ç¼–è¾‘
                            </button>
                            <button class="btn btn-small ${config.enabled ? 'btn-secondary' : 'btn-success'}"
                                    onclick="toggleConfig('${config.id}', ${!config.enabled})">
                                ${config.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
                            </button>
                            <button class="btn btn-small btn-danger" onclick="deleteConfig('${config.id}')">
                                åˆ é™¤
                            </button>
                        </div>
                    </div>
                    <div class="config-details">
                        <div><strong>æ¨¡å‹:</strong> ${escapeHtml(config.model)}</div>
                        <div><strong>URL:</strong> ${escapeHtml(config.base_url)}</div>
                        <div><strong>API Key:</strong> ${maskApiKey(config.api_key)}</div>
                    </div>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºæ·»åŠ é…ç½®è¡¨å•
        function showAddConfigForm() {
            document.getElementById('formTitle').textContent = 'æ·»åŠ æ–°é…ç½®';
            document.getElementById('configForm').reset();
            document.getElementById('configId').value = '';
            document.getElementById('configFormModal').classList.add('active');
        }

        // å…³é—­é…ç½®è¡¨å•æ¨¡æ€çª—å£
        function closeConfigForm() {
            document.getElementById('configFormModal').classList.remove('active');
            document.getElementById('configForm').reset();
        }

        // ç¼–è¾‘é…ç½®
        async function editConfig(configId) {
            try {
                const response = await fetch(`/api/ai-configs/${configId}`);
                const data = await response.json();

                if (data.success) {
                    const config = data.config;

                    document.getElementById('formTitle').textContent = 'ç¼–è¾‘é…ç½®';
                    document.getElementById('configId').value = config.id;
                    document.getElementById('configName').value = config.name;
                    document.getElementById('configBaseUrl').value = config.base_url;
                    document.getElementById('configApiKey').value = config.api_key;
                    document.getElementById('configModel').value = config.model;
                    document.getElementById('configFormModal').classList.add('active');
                } else {
                    alert('åŠ è½½é…ç½®å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                alert('åŠ è½½é…ç½®å¤±è´¥: ' + error.message);
            }
        }

        // ä¿å­˜é…ç½®
        async function saveConfig(event) {
            event.preventDefault();

            const configId = document.getElementById('configId').value;
            const configData = {
                name: document.getElementById('configName').value,
                base_url: document.getElementById('configBaseUrl').value,
                api_key: document.getElementById('configApiKey').value,
                model: document.getElementById('configModel').value,
                priority: 0,  // é»˜è®¤ä¼˜å…ˆçº§ä¸º0
                enabled: false  // é»˜è®¤ç¦ç”¨ï¼Œé¿å…å†²çª
            };

            try {
                let response;
                if (configId) {
                    // æ›´æ–°ç°æœ‰é…ç½®æ—¶ï¼Œä¿æŒåŸæœ‰çš„å¯ç”¨çŠ¶æ€
                    const getResponse = await fetch(`/api/ai-configs/${configId}`);
                    const getData = await getResponse.json();
                    if (getData.success) {
                        configData.enabled = getData.config.enabled;
                    }

                    response = await fetch(`/api/ai-configs/${configId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(configData)
                    });
                } else {
                    // åˆ›å»ºæ–°é…ç½®
                    response = await fetch('/api/ai-configs', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(configData)
                    });
                }

                const data = await response.json();

                if (data.success) {
                    closeConfigForm();
                    await loadConfigs();
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + (data.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                alert('ä¿å­˜é…ç½®å¤±è´¥: ' + error.message);
            }
        }

        // å¯ç”¨/ç¦ç”¨é…ç½®ï¼ˆå•é€‰æ¨¡å¼ï¼šåªèƒ½å¯ç”¨ä¸€ä¸ªï¼‰
        async function toggleConfig(configId, enabled) {
            try {
                if (enabled) {
                    // å¦‚æœè¦å¯ç”¨ï¼Œå…ˆç¦ç”¨æ‰€æœ‰å…¶ä»–é…ç½®
                    const allConfigsResponse = await fetch('/api/ai-configs');
                    const allConfigsData = await allConfigsResponse.json();

                    if (allConfigsData.success) {
                        // ç¦ç”¨æ‰€æœ‰å·²å¯ç”¨çš„é…ç½®
                        for (const config of allConfigsData.configs) {
                            if (config.enabled && config.id !== configId) {
                                await fetch(`/api/ai-configs/${config.id}`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ enabled: false })
                                });
                            }
                        }
                    }
                }

                // æ›´æ–°ç›®æ ‡é…ç½®çš„çŠ¶æ€
                const response = await fetch(`/api/ai-configs/${configId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: enabled })
                });

                const data = await response.json();

                if (data.success) {
                    await loadConfigs();
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + (data.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('æ›´æ–°é…ç½®å¤±è´¥:', error);
                alert('æ›´æ–°é…ç½®å¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤é…ç½®
        async function deleteConfig(configId) {
            try {
                const response = await fetch(`/api/ai-configs/${configId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    await loadConfigs();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + (data.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åˆ é™¤é…ç½®å¤±è´¥:', error);
                alert('åˆ é™¤é…ç½®å¤±è´¥: ' + error.message);
            }
        }

        // å·¥å…·å‡½æ•°ï¼šè½¬ä¹‰ HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // å·¥å…·å‡½æ•°ï¼šé®è”½ API Key
        function maskApiKey(apiKey) {
            if (!apiKey || apiKey.length < 8) {
                return '***';
            }
            return apiKey.substring(0, 10) + '***' + apiKey.substring(apiKey.length - 4);
        }
    </script>

    <!-- æ¨¡æ¿æµè§ˆé¡µé¢æ¨¡æ€çª—å£ -->
    <div class="template-modal" id="templateModal">
        <!-- æ¨¡æ¿åˆ—è¡¨é¡µ -->
        <div class="template-modal-content" id="templateListPage">
            <div class="template-modal-header">
                <div class="template-modal-title">
                    <span>ğŸ¨</span>
                    <span>é€‰æ‹©ç»˜å›¾æ¨¡æ¿</span>
                </div>
                <button class="template-modal-close" onclick="closeTemplateModal()">
                    âœ•
                </button>
            </div>
            <div class="template-modal-body">
                <div class="template-grid" id="templateGrid">
                    <!-- æ¨¡æ¿å¡ç‰‡å°†é€šè¿‡ JS åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- æ¨¡æ¿è¯¦æƒ…é¡µ -->
        <div class="template-modal-content template-detail-page" id="templateDetailPage" style="display: none;">
            <div class="template-modal-header">
                <button class="btn-back" onclick="backToTemplateList()">
                    â† è¿”å›
                </button>
                <div class="template-modal-title" id="templateDetailTitle">
                    <span>ğŸ“</span>
                    <span>ç§‘ç ”ç»˜å›¾é£æ ¼</span>
                </div>
                <button class="template-modal-close" onclick="closeTemplateModal()">
                    âœ•
                </button>
            </div>
            <div class="template-modal-body template-detail-body">
                <!-- è¯¦æƒ…å†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                <div class="template-detail-container" id="templateDetailContainer">
                </div>
            </div>
            <div class="template-modal-footer">
                <div class="template-detail-actions">
                    <button class="btn-template-cancel" onclick="backToTemplateList()">
                        è¿”å›åˆ—è¡¨
                    </button>
                    <button class="btn-template-apply" onclick="applyTemplateFromDetail()">
                        åº”ç”¨æ­¤æ¨¡æ¿
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
